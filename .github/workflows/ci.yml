name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # ä»£ç æ£€æŸ¥
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check code quality
        run: |
          echo "ğŸ” Running code quality checks..."
          # æ£€æŸ¥ HTML è¯­æ³•
          if command -v htmlhint &> /dev/null; then
            htmlhint demo.html || true
          fi
          echo "âœ… Code check completed"

  # è‡ªåŠ¨ç‰ˆæœ¬ç®¡ç†
  version:
    runs-on: ubuntu-latest
    needs: lint
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get current version
        id: version
        run: |
          CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: new_version
        run: |
          # æ ¹æ®æäº¤ä¿¡æ¯åˆ¤æ–­ç‰ˆæœ¬ç±»å‹
          LAST_MSG=$(git log -1 --pretty=%B)

          if [[ "$LAST_MSG" == *"BREAKING"* ]] || [[ "$LAST_MSG" == *"major:"* ]]; then
            BUMP="major"
          elif [[ "$LAST_MSG" == *"feat:"* ]] || [[ "$LAST_MSG" == *"feature:"* ]]; then
            BUMP="minor"
          else
            BUMP="patch"
          fi

          CURRENT=${{ steps.version.outputs.current }}
          CURRENT=${CURRENT#v}

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case $BUMP in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Create tag
        run: |
          git tag -a ${{ steps.new_version.outputs.version }} -m "Release ${{ steps.new_version.outputs.version }}"
          git push origin ${{ steps.new_version.outputs.version }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.new_version.outputs.version }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # AI ä»£ç å®¡æŸ¥ï¼ˆä½¿ç”¨ Kimi APIï¼‰
  ai-review:
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR changes
        id: changes
        run: |
          git diff origin/main...HEAD > diff.txt
          echo "files=$(git diff --name-only origin/main...HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: AI Code Review with Kimi
        env:
          KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        run: |
          echo "ğŸ¤– Running AI code review with Kimi..."

          DIFF_CONTENT=$(cat diff.txt | head -200 | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

          REVIEW=$(curl -s https://api.moonshot.cn/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $KIMI_API_KEY" \
            -d '{
              "model": "moonshot-v1-8k",
              "temperature": 0.3,
              "messages": [{
                "role": "system",
                "content": "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä»£ç å®¡æŸ¥ä¸“å®¶ã€‚è¯·ç”¨ä¸­æ–‡å®¡æŸ¥ä»£ç å˜æ›´ï¼Œæä¾›ç®€æ´çš„åé¦ˆï¼ŒåŒ…æ‹¬ï¼š1. æ½œåœ¨é—®é¢˜ 2. æ”¹è¿›å»ºè®® 3. ä»£ç è´¨é‡è¯„ä»·"
              }, {
                "role": "user",
                "content": "è¯·å®¡æŸ¥ä»¥ä¸‹ä»£ç å˜æ›´ï¼š\n\n'"$DIFF_CONTENT"'"
              }]
            }')

          echo "$REVIEW" | jq -r '.choices[0].message.content' > review.md || echo "API call failed" > review.md

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let review = fs.readFileSync('review.md', 'utf8');
            if (review.includes('API call failed')) {
              review = 'ä»£ç å®¡æŸ¥æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚';
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ¤– Kimi AI ä»£ç å®¡æŸ¥\n\n${review}`
            });

  # è‡ªåŠ¨ PRï¼ˆå®šæœŸä» develop åˆå¹¶åˆ° mainï¼‰
  auto-pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create PR
        run: |
          gh pr create \
            --base main \
            --head develop \
            --title "ğŸš€ Auto PR: Develop to Main" \
            --body "è‡ªåŠ¨åŒ– PRï¼šå°† develop åˆ†æ”¯åˆå¹¶åˆ° main" \
            --label "auto-merge" || echo "PR already exists"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
