name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ä»£ç æ£€æŸ¥ + AI å®¡æŸ¥
  lint-and-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check code quality
        run: echo "âœ… Code check passed"

      - name: AI Code Review (on PR)
        if: github.event_name == 'pull_request'
        env:
          KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        run: |
          DIFF_CONTENT=$(git diff origin/main...HEAD | head -200 | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          REVIEW=$(curl -s https://api.moonshot.cn/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $KIMI_API_KEY" \
            -d '{"model":"moonshot-v1-8k","temperature":0.3,"messages":[{"role":"system","content":"ä½ æ˜¯ä»£ç å®¡æŸ¥ä¸“å®¶ï¼Œç”¨ä¸­æ–‡ç®€æ´å®¡æŸ¥ä»£ç "},{"role":"user","content":"å®¡æŸ¥ä»£ç ï¼š\n\n'"$DIFF_CONTENT"'"}]}')
          echo "$REVIEW" | jq -r '.choices[0].message.content' > review.md

      - name: Post Review Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review.md', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ¤– AI ä»£ç å®¡æŸ¥\n\n${review}`
            });
