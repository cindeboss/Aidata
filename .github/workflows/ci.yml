name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ä»£ç æ£€æŸ¥ + AI å®¡æŸ¥
  lint-and-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check code quality
        run: |
          echo "âœ… Code check passed"

      - name: AI Code Review (on PR)
        if: github.event_name == 'pull_request'
        env:
          KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        run: |
          DIFF_CONTENT=$(git diff origin/main...HEAD | head -200 | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

          REVIEW=$(curl -s https://api.moonshot.cn/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $KIMI_API_KEY" \
            -d '{
              "model": "moonshot-v1-8k",
              "temperature": 0.3,
              "messages": [{
                "role": "system",
                "content": "ä½ æ˜¯ä¸€ä½ä»£ç å®¡æŸ¥ä¸“å®¶ã€‚ç”¨ä¸­æ–‡ç®€æ´åœ°å®¡æŸ¥ä»£ç ï¼ŒæŒ‡å‡ºé—®é¢˜å’Œå»ºè®®ã€‚"
              }, {
                "role": "user",
                "content": "å®¡æŸ¥ä»£ç ï¼š\n\n'"$DIFF_CONTENT"'"
              }]
            }')

          echo "$REVIEW" | jq -r '.choices[0].message.content' > review.md

      - name: Post Review Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review.md', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ¤– AI ä»£ç å®¡æŸ¥\n\n${review}`
            });

  # è‡ªåŠ¨ç‰ˆæœ¬ç®¡ç†
  version:
    runs-on: ubuntu-latest
    needs: lint-and-review
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Calculate version
        id: version
        run: |
          CURRENT=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          CURRENT=${CURRENT#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          MSG=$(git log -1 --pretty=%B)
          if [[ "$MSG" == *"BREAKING"* ]] || [[ "$MSG" == *"major:"* ]]; then
            MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0
          elif [[ "$MSG" == *"feat:"* ]]; then
            MINOR=$((MINOR + 1)); PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi

          echo "version=v$MAJOR.$MINOR.$PATCH" >> $GITHUB_OUTPUT

      - name: Create Release
        run: |
          git tag -a ${{ steps.version.outputs.version }} -m "Release ${{ steps.version.outputs.version }}"
          git push origin ${{ steps.version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
